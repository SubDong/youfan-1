<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.youfan.data.mappers.OrderMapper">


    <resultMap id="OrderEntityMap" type="com.youfan.data.models.OrderEntity">
        <id column="ORDER_ID" property="id"/>
        <result column="ORDER_NO" property="orderNo"/>
        <result column="SELLER_ID" property="sellerId"/>
        <result column="BUYER_ID" property="buyerId"/>
        <result column="COMMENTS" property="comments"/>
        <result column="ORDER_STATUS" property="orderStatus"/>

    </resultMap>


    <resultMap id="MerchantOrderHeader" type="com.youfan.commons.vo.MerchantOrderHeaderVO">

        <result column="ORDER_NO" property="orderNo"/>
        <result column="BUYER_ID" property="buyerId"/>
        <result column="ORDER_STATUS" property="orderStatus"/>
        <result column="repast_Time" property="repastTime"/>
        <result column="repast_Address" property="repastAddress"/>
        <result column="dishes_Id" property="dishesId"/>
    </resultMap>
    
    
       <resultMap id="MerchantOrderDetail" type="com.youfan.commons.vo.MerchantOrderDetailVO">

        <result column="ORDER_NO" property="orderNo"/>
        <result column="BUYER_ID" property="buyerId"/>
        <result column="ORDER_STATUS" property="orderStatus"/>
        <result column="repast_Time" property="repastTime"/>
        <result column="order_time" property="orderTime"/>
        <result column="repast_Address" property="repastAddress"/>
        <result column="dishes_Id" property="dishesId"/>
    </resultMap>


    <select id="getOrder" parameterType="int"
            resultMap="OrderEntityMap">
        SELECT * FROM TBL_ORDERS WHERE ORDER_ID=#{id} AND DATA_STATUS = 1
    </select>

    <update id="deleteOrder" parameterType="java.lang.Integer">
        UPDATE TBL_ORDERS SET DATA_STATUS = 0 WHERE ORDER_ID = #{id}
    </update>

    <insert id="createOrder" parameterType="com.youfan.data.models.OrderEntity">
        INSERT INTO TBL_ORDERS(ORDER_NO,SELLER_ID,BUYER_ID,ORDER_PRICE,ORDER_STATUS) VALUES(#{orderNo},#{sellerId},#{buyerId},#{price},#{orderStatus})
    </insert>

    <insert id="createOrderDishRel" parameterType="com.youfan.data.models.OrderDishRelEntity">
        INSERT INTO TBL_REL_ODR_DISH(ODR_ID,DISH_ID) VALUES(#{orderNo},#{itemId})
    </insert>

    <select id="findAll">
        SELECT * FROM TBL_ORDERS
    </select>

    <select id="findAllByPagination" parameterType="com.youfan.commons.Pagination">
        SELECT *  FROM TBL_ORDERS LIMIT #{start}, #{end} ORDER BY #{orderBy} #{asc}
    </select>

    <select id="getOrdersByBuyerId">
        SELECT *  FROM TBL_ORDERS WHERE BUYER_ID = #{0} AND DATA_STATUS = 1 LIMIT #{start}, #{end} ORDER BY #{1}.orderBy #{1}.asc
    </select>

    <select id="getOrdersBySellerId">
        SELECT *  FROM TBL_ORDERS WHERE SELLER_ID = #{0} AND DATA_STATUS = 1 LIMIT #{start}, #{end} ORDER BY #{1}.orderBy #{1}.asc
    </select>

    <select id="findOrders" parameterType="com.youfan.data.models.OrderEntity" resultMap="MerchantOrderHeader">


       SELECT
	orders.ORDER_NO,
	orders.repast_Address,
	orders.repast_Time,
	orders.BUYER_ID,
	orders.price,
	orders.order_status,
	dishes.dishes_Id
FROM
	TBL_ORDERS orders
JOIN (
	SELECT
		orders.order_id,
		group_concat(dishes.DISH_ID) AS dishes_Id
	FROM
		TBL_ORDERS orders
	JOIN TBL_REL_ODR_DISH dishes ON orders.order_id = dishes.order_id
	GROUP BY
		orders.order_id
) dishes ON orders.order_id = dishes.order_id
WHERE
	1 = 1

        <if test="sellerId != null and sellerId != ''">
            and orders.seller_Id = #{sellerId}
        </if>

        <if test="orderStatus != null">
            and orders.order_Status = #{orderStatus}
        </if>

        <if test="repastMode != null and repastMode != ''">
            and orders.repast_Mode = #{repastMode}
        </if>

    </select>
    
    
     <select id="findOrderDetail" parameterType="com.youfan.data.models.OrderEntity" resultMap="MerchantOrderDetail">


       SELECT
	orders.ORDER_NO,
	orders.repast_Address,
	orders.repast_Time,
	orders.order_time,
	orders.BUYER_ID,
	orders.price,
	dishes.dishes_Id
FROM
	TBL_ORDERS orders
JOIN (
	SELECT
		orders.order_id,
		group_concat(dishes.DISH_ID) AS dishes_Id
	FROM
		TBL_ORDERS orders
	JOIN TBL_REL_ODR_DISH dishes ON orders.order_id = dishes.order_id
	GROUP BY
		orders.order_id
) dishes ON orders.order_id = dishes.order_id
WHERE
	1 = 1

        <if test="orderNo != null and orderNo != ''">
            and orders.ORDER_NO = #{orderNo}
        </if>

      

    </select>


</mapper>